import h from"@walletconnect/sign-client";import{IJsonRpcConnection as c}from"@walletconnect/jsonrpc-types";import{formatJsonRpcResult as a,formatJsonRpcError as d}from"@walletconnect/jsonrpc-utils";import{getChainsFromNamespaces as p,getChainsFromRequiredNamespaces as l,getAccountsFromNamespaces as u,getSdkError as m}from"@walletconnect/utils";import{EventEmitter as f}from"events";function v(n){return typeof n<"u"&&typeof n.context<"u"}const s={init:"signer_init",uri:"signer_uri",created:"signer_created",updated:"signer_updated",deleted:"signer_deleted",event:"signer_event"};class r extends c{constructor(e){super(),this.events=new f,this.pending=!1,this.initializing=!1,this.requiredNamespaces=e?.requiredNamespaces||{},this.opts=e?.client}get connected(){return typeof this.session<"u"}get connecting(){return this.pending}get chains(){return this.session?p(this.session.namespaces):l(this.requiredNamespaces)}get accounts(){return this.session?u(this.session.namespaces):[]}on(e,i){this.events.on(e,i)}once(e,i){this.events.once(e,i)}off(e,i){this.events.off(e,i)}removeListener(e,i){this.events.removeListener(e,i)}async open(){if(this.pending)return new Promise((e,i)=>{this.events.once("open",()=>{if(this.events.once("open_error",t=>{i(t)}),typeof this.client>"u")return i(new Error("Sign Client not initialized"));e()})});try{this.pending=!0;const e=await this.register(),i=e.find({requiredNamespaces:this.requiredNamespaces});if(i.length)return this.onOpen(i[0]);const{uri:t,approval:o}=await e.connect({requiredNamespaces:this.requiredNamespaces});this.events.emit(s.uri,{uri:t}),this.session=await o(),this.events.emit(s.created,this.session),this.onOpen()}catch(e){throw this.events.emit("open_error",e),e}}async close(){typeof this.session>"u"||(await(await this.register()).disconnect({topic:this.session.topic,reason:m("USER_DISCONNECTED")}),this.onClose())}async send(e,i){if(typeof this.client>"u"&&(this.client=await this.register(),this.connected||await this.open()),typeof this.session>"u")throw new Error("Signer connection is missing session");this.client.request({topic:this.session.topic,request:e,chainId:i?.chainId}).then(t=>this.events.emit("payload",a(e.id,t))).catch(t=>this.events.emit("payload",d(e.id,t.message)))}async register(e=this.opts){if(typeof this.client<"u")return this.client;if(this.initializing)return new Promise((i,t)=>{this.events.once("register_error",o=>{t(o)}),this.events.once(s.init,()=>{if(typeof this.client>"u")return t(new Error("Sign Client not initialized"));i(this.client)})});if(v(e))return this.client=e,this.registerEventListeners(),this.client;try{return this.initializing=!0,this.client=await h.init(e),this.initializing=!1,this.registerEventListeners(),this.events.emit(s.init),this.client}catch(i){throw this.events.emit("register_error",i),i}}onOpen(e){this.pending=!1,e&&(this.session=e),this.events.emit("open")}onClose(){this.pending=!1,this.client&&(this.client=void 0),this.events.emit("close")}registerEventListeners(){typeof this.client<"u"&&(this.client.on("session_event",e=>{var i;this.session&&((i=this.session)==null?void 0:i.topic)!==e.topic||this.events.emit(s.event,e.params)}),this.client.on("session_update",e=>{var i;typeof this.client<"u"&&(this.session&&((i=this.session)==null?void 0:i.topic)!==e.topic||(this.session=this.client.session.get(e.topic),this.events.emit(s.updated,this.session)))}),this.client.on("session_delete",e=>{var i;this.session&&(this.session&&((i=this.session)==null?void 0:i.topic)!==e.topic||(this.onClose(),this.events.emit(s.deleted,this.session),this.session=void 0))}))}}export{s as SIGNER_EVENTS,r as SignerConnection,r as default};
//# sourceMappingURL=index.es.js.map
